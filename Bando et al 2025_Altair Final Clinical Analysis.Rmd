---
title: "Bando et al 2025_Altair Final Clinical Analysis"
output: html_notebook
---

library(swimplot)
library(coxphf)
library(grid)
library(gtable)
library(readr) 
library(mosaic)
library(dplyr) 
library(survival) 
library(survminer)
library(gridtext)
library(ggplot2)
library(scales)
library(officer)
library(ggthemes)
library(tidyverse)
library(gtsummary)
library(flextable)
library(parameters)
library(car)
library(grid)
library(ComplexHeatmap)
library(readxl)
library(janitor)
library(rms)
library(pROC)
library(DT)

#Demographics Table by Altair Arm
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")

circ_data_subset1 <- circ_data %>%
  select(
    Age.Group,
    Sex,
    PrimSitev2,
    StageA.alt,
    p_hadNeo,
    p_TxAdjAltair,
    ctDNA1mo,
    p_AltBaselineWin,
    BRAF.V600E,
    RAS,
    MSI) %>%
  mutate(
    Age.Group = factor(Age.Group, levels = c("1", "2"), labels = c("<70", ">70")),
    Sex = factor(Sex, levels = c("Male", "Female")),
    PrimSitev2 = factor(PrimSitev2, levels = c("Right-sided colon", "Left-sided colon", "Rectum")),
    StageA.alt = factor(StageA.alt, levels = c("I", "II", "III", "IV")),
    p_hadNeo = factor(p_hadNeo, levels=c("FALSE","TRUE"), labels = c("No", "Yes")),
    p_TxAdjAltair = factor(p_TxAdjAltair, levels=c("FALSE","TRUE"), labels = c("No", "Yes")),
    ctDNA1mo = factor(ctDNA1mo, levels = c("NEGATIVE", "POSITIVE"), labels = c("Negative", "Positive")),
    p_AltBaselineWin = factor(p_AltBaselineWin, levels = c("MRD", "OnTreatment", "Surveillance")),
    BRAF.V600E = factor(BRAF.V600E, levels = c("WT", "MUT"), labels = c("BRAF wt", "BRAF V600E")),
    RAS = factor(RAS, levels = c("WT", "MUT"), labels = c("RAS wt", "RAS mut")),
    MSI = factor(MSI, levels = c("MSS", "MSI-High")))

circ_data1 <- read.csv("Altair 20240729 Dataset.csv")

circ_data_subset2 <- circ_data1 %>%
  select(
    Age.Group,
    Sex,
    PrimSitev2,
    StageA.alt,
    p_hadNeo,
    p_TxAdjAltair,
    ctDNA1mo,
    p_AltBaselineWin,
    BRAF.V600E,
    RAS,
    MSI,
    altair.Arm) %>%
  mutate(
    Age.Group = factor(Age.Group, levels = c("1", "2"), labels = c("<70", ">70")),
    Sex = factor(Sex, levels = c("Male", "Female")),
    PrimSitev2 = factor(PrimSitev2, levels = c("Right-sided colon", "Left-sided colon", "Rectum")),
    StageA.alt = factor(StageA.alt, levels = c("I", "II", "III", "IV")),
    p_hadNeo = factor(p_hadNeo, levels=c("FALSE","TRUE"), labels = c("No", "Yes")),
    p_TxAdjAltair = factor(p_TxAdjAltair, levels=c("FALSE","TRUE"), labels = c("No", "Yes")),
    ctDNA1mo = factor(ctDNA1mo, levels = c("NEGATIVE", "POSITIVE"), labels = c("Negative", "Positive")),
    p_AltBaselineWin = factor(p_AltBaselineWin, levels = c("MRD", "OnTreatment", "Surveillance")),
    BRAF.V600E = factor(BRAF.V600E, levels = c("WT", "MUT"), labels = c("BRAF wt", "BRAF V600E")),
    RAS = factor(RAS, levels = c("WT", "MUT"), labels = c("RAS wt", "RAS mut")),
    MSI = factor(MSI, levels = c("MSS", "MSI-High")),
    altair.Arm = factor(altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI")))
Overall <- circ_data_subset1 %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{median} ({min} - {max})",
      all_categorical() ~ "{n} ({p}%)")) %>%
  bold_labels()
Overall

ByctDNA_MRD <- circ_data_subset2 %>%
  tbl_summary(
    by = altair.Arm, # add this line to subgroup by altair.Arm
    statistic = list(
      all_continuous() ~ "{median} ({min} - {max})",
      all_categorical() ~ "{n} ({p}%)")) %>%
  add_p() %>%
  bold_labels()
ByctDNA_MRD

merged_table <- tbl_merge(tbls=list(Overall, ByctDNA_MRD))
merged_table

fit1 <- as_flex_table(
  merged_table,
  include = everything(),
  return_calls = FALSE
)
fit1
save_as_docx(fit1, path = "~/Downloads/merged_table.docx")
```

#Median enrollment MTM/mL in the complete cohort
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)

median_val <- median(circ_data$p_AltBaselineMTM, na.rm = TRUE)
q1_val <- quantile(circ_data$p_AltBaselineMTM, 0.25, na.rm = TRUE)
q3_val <- quantile(circ_data$p_AltBaselineMTM, 0.75, na.rm = TRUE)
range_val <- range(circ_data$p_AltBaselineMTM, na.rm = TRUE)
cat("Median:", format(median_val, digits = 4), "\n")
cat("Q1 (25th percentile):", q1_val, "\n")
cat("Q3 (75th percentile):", q3_val, "\n")
cat("Range:", range_val, "\n")
```

#Median enrollment MTM/mL by Stage
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)
circ_data$StageA.alt <- factor(circ_data$StageA.alt, levels = c("I", "II", "III", "IV"))

stage_summary <- circ_data %>%
  group_by(StageA.alt) %>%
  summarise(
    Median = median(p_AltBaselineMTM, na.rm = TRUE),
    Q1 = quantile(p_AltBaselineMTM, 0.25, na.rm = TRUE),
    Q3 = quantile(p_AltBaselineMTM, 0.75, na.rm = TRUE),
    Min = min(p_AltBaselineMTM, na.rm = TRUE),
    Max = max(p_AltBaselineMTM, na.rm = TRUE)
  ) %>%
  ungroup()
print(stage_summary)
```

#Median enrollment MTM/mL by enrollment window
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)
circ_data$p_AltBaselineWin <- factor(circ_data$p_AltBaselineWin, levels = c("MRD", "OnTreatment", "Surveillance"))

stage_summary <- circ_data %>%
  group_by(p_AltBaselineWin) %>%
  summarise(
    Median = median(p_AltBaselineMTM, na.rm = TRUE),
    Q1 = quantile(p_AltBaselineMTM, 0.25, na.rm = TRUE),
    Q3 = quantile(p_AltBaselineMTM, 0.75, na.rm = TRUE),
    Min = min(p_AltBaselineMTM, na.rm = TRUE),
    Max = max(p_AltBaselineMTM, na.rm = TRUE)
  ) %>%
  ungroup()
print(stage_summary)
```

#Median enrollment MTM/mL by enrollment window in each treatment arm
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)
circ_data$p_AltBaselineWin <- factor(circ_data$p_AltBaselineWin, levels = c("MRD", "OnTreatment", "Surveillance"))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels = c("Control", "Experimental"), labels = c("Placebo", "FTD/TPI"))

# 1. Summary statistics by p_AltBaselineWin
stage_summary <- circ_data %>%
  group_by(p_AltBaselineWin) %>%
  summarise(
    Median = median(p_AltBaselineMTM, na.rm = TRUE),
    Q1 = quantile(p_AltBaselineMTM, 0.25, na.rm = TRUE),
    Q3 = quantile(p_AltBaselineMTM, 0.75, na.rm = TRUE),
    Min = min(p_AltBaselineMTM, na.rm = TRUE),
    Max = max(p_AltBaselineMTM, na.rm = TRUE)
  ) %>%
  ungroup()
print("Summary by p_AltBaselineWin:")
print(stage_summary)

# 2. Median by p_AltBaselineWin and altair.Arm
arm_stage_summary <- circ_data %>%
  group_by(p_AltBaselineWin, altair.Arm) %>%
  summarise(
    Median = median(p_AltBaselineMTM, na.rm = TRUE),
    n = n()
  ) %>%
  ungroup()
print("Median p_AltBaselineMTM by p_AltBaselineWin and altair.Arm:")
print(arm_stage_summary)

# 3. Wilcoxon test p-values for Control vs Experimental within each p_AltBaselineWin
p_values <- circ_data %>%
  filter(!is.na(p_AltBaselineMTM), !is.na(altair.Arm), !is.na(p_AltBaselineWin)) %>%
  group_by(p_AltBaselineWin) %>%
  summarise(
    p_value = tryCatch(
      wilcox.test(p_AltBaselineMTM ~ altair.Arm)$p.value,
      error = function(e) NA
    )
  )
print("Wilcoxon test p-values by p_AltBaselineWin:")
print(p_values)
```

#Median enrollment MTM/mL in Stage IV vs Non-Stage IV
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[!(circ_data$StageA.alt %in% c("I", "II", "III")),]
circ_datadf <- as.data.frame(circ_data)

median_val <- median(circ_data$p_AltBaselineMTM, na.rm = TRUE)
q1_val <- quantile(circ_data$p_AltBaselineMTM, 0.25, na.rm = TRUE)
q3_val <- quantile(circ_data$p_AltBaselineMTM, 0.75, na.rm = TRUE)
range_val <- range(circ_data$p_AltBaselineMTM, na.rm = TRUE)
cat("Median:", format(median_val, digits = 4), "\n")
cat("Q1 (25th percentile):", q1_val, "\n")
cat("Q3 (75th percentile):", q3_val, "\n")
cat("Range:", range_val, "\n")

rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)
circ_data$Stage.Final <- factor(circ_data$Stage.Final, levels = c("I-III", "IV"))
median_MTM <- aggregate(p_AltBaselineMTM ~ Stage.Final, data = circ_data, FUN = median)
print(median_MTM)
circ_data$Stage.Final <- factor(circ_data$Stage.Final, levels = c("I-III", "IV"))
boxplot(p_AltBaselineMTM~Stage.Final, data=circ_data, main="MTM/mL at enrollment", xlab="Stage", ylab="MTM/mL", col="white",border="black")
m1<-wilcox.test(p_AltBaselineMTM ~ Stage.Final, data=circ_data, na.rm=TRUE, exact=FALSE, conf.int=TRUE)
print(m1)
```

#Number of patients with enrolment MTM/mL > various thresholds
```{r}
rm(list = ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data$p_AltBaselineMTM <- as.numeric(circ_data$p_AltBaselineMTM)

# Define your cutoffs
cutoffs <- c(0.01, 0.047, 0.1, 0.179, 0.2, 0.3, 0.5, 1, 5, 8.172, 10)
total_pts <- nrow(circ_data)
for (co in cutoffs) {
  pts_above <- sum(circ_data$p_AltBaselineMTM >= co, na.rm = TRUE)
  perc      <- (pts_above / total_pts) * 100
  cat("Cutoff:", co, 
      "- Patients ≥ cutoff:", pts_above, 
      "- Percentage:", round(perc, 2), "%\n")
}
```

#DFS1 by TAS vs Placebo - All stages & stratified for Stage & ctDNA 1mo post-surgery
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - All Patients", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
circ_data$Disease.Stage <- factor(circ_data$Disease.Stage, levels=c("Stage II or lower","StageIII", "M1"))
circ_data$ctDNA1mo <- factor(circ_data$ctDNA1mo, levels=c("NEGATIVE","POSITIVE"), labels = c("Negative", "Positive"))
cox_fit_stratified <- coxph(surv_object ~ altair.Arm + strata(Disease.Stage) + strata(ctDNA1mo), data = circ_data)
summary(cox_fit_stratified)

# Extract values for HR, 95% CI, and p-value
cox_fit_summary_stratified <- summary(cox_fit_stratified)
HR_stratified <- cox_fit_summary_stratified$coefficients[2]
lower_CI_stratified <- cox_fit_summary_stratified$conf.int[3]
upper_CI_stratified <- cox_fit_summary_stratified$conf.int[4]
p_value_stratified <- cox_fit_summary_stratified$coefficients[5]
label_text_stratified <- paste0("HR = ", round(HR_stratified, 2), 
                                " (", round(lower_CI_stratified, 2), "-", 
                                round(upper_CI_stratified, 2), "); p = ", 
                                round(p_value_stratified, 3))
print(label_text_stratified)
```




#DFS1 by TAS vs Placebo - Excluding QC patients
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$QC.Exclude=="FALSE",]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - Excluding those with QC Revisions", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```




#DFS1 by TAS vs Placebo - Excluding Mets patients
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$Mets.Exclude=="FALSE",]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - Excluding those with Mets prior to enrolment", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```




#DFS1 by TAS vs Placebo - Stage I-III
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[!(circ_data$StageA.alt %in% c("IV")),]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - Stage I-III", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```


#DFS1 by TAS vs Placebo - Stage I-II
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[!(circ_data$StageA.alt %in% c("III","IV")),]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - Stage I-II", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```


#DFS1 by TAS vs Placebo - Stage III
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[!(circ_data$StageA.alt %in% c("I", "II", "IV")),]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - Stage III", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```


#DFS1 by TAS vs Placebo - Stage IV
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[!(circ_data$StageA.alt %in% c("I", "II", "III")),]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - Stage IV", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```



#DFS1 by TAS vs Placebo - ctDNA positive post-surgery
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$ctDNA1mo == "POSITIVE",]
circ_data <- subset(circ_data, !is.na(p_MRD))
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - ctDNA positive post-surgery", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Fisher test for DFS percentages at 6, 12, 18 and 24 months
dfs_times <- c(6, 12, 18, 24)
p_values <- sapply(dfs_times, function(time) {
  neg_count <- sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  pos_count <- sum(circ_data$altair.Arm == "Placebo" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  neg_total <- sum(circ_data$altair.Arm == "FTD/TPI")
  pos_total <- sum(circ_data$altair.Arm == "Placebo")
  
  neg_surv <- neg_total - sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  pos_surv <- pos_total - sum(circ_data$altair.Arm == "Placebo" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  
  surv_matrix <- matrix(c(neg_surv, pos_surv, neg_total - neg_surv, pos_total - pos_surv), nrow = 2)
  test_result <- fisher.test(surv_matrix)
  return(test_result$p.value)
})
names(p_values) <- paste0("p-value at ", dfs_times, " months")
print(p_values)
```

#DFS1 by TAS vs Placebo - ctDNA negative post-surgery
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$ctDNA1mo == "NEGATIVE",]
circ_data <- subset(circ_data, !is.na(ctDNA1mo))
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - ctDNA negative post-surgery", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```

#DFS2 by TAS vs Placebo - All stages
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS2.months, event = circ_data$p_evtDFS2)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS2),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS2.months, event = circ_data$p_evtDFS2)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS2 by Arm", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```

#OS by TAS vs Placebo - All stages
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$OS.months, event = circ_data$p_evtOS)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtOS),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$OS.months, event = circ_data$p_evtOS)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="OS by Arm - All Patients", ylab= "Overall Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```
#DFS1 by ctDNA MRD enrollment timepoint TAS vs Placebo
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$p_AltBaselineWin=="MRD",]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - ctDNA MRD Enrollment", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Fisher test for DFS percentages at 6, 12, 18 and 24 months
dfs_times <- c(6, 12, 18, 24)
p_values <- sapply(dfs_times, function(time) {
  neg_count <- sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  pos_count <- sum(circ_data$altair.Arm == "Placebo" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  neg_total <- sum(circ_data$altair.Arm == "FTD/TPI")
  pos_total <- sum(circ_data$altair.Arm == "Placebo")
  
  neg_surv <- neg_total - sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  pos_surv <- pos_total - sum(circ_data$altair.Arm == "Placebo" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  
  surv_matrix <- matrix(c(neg_surv, pos_surv, neg_total - neg_surv, pos_total - pos_surv), nrow = 2)
  test_result <- fisher.test(surv_matrix)
  return(test_result$p.value)
})
names(p_values) <- paste0("p-value at ", dfs_times, " months")
print(p_values)
```


#DFS1 by ctDNA On-treatment timepoint TAS vs Placebo
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$p_AltBaselineWin=="OnTreatment",]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - ctDNA On-treatment Enrollment", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Fisher test for DFS percentages at 6, 12, 18 and 24 months
dfs_times <- c(6, 12, 18, 24)
p_values <- sapply(dfs_times, function(time) {
  neg_count <- sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  pos_count <- sum(circ_data$altair.Arm == "Placebo" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  neg_total <- sum(circ_data$altair.Arm == "FTD/TPI")
  pos_total <- sum(circ_data$altair.Arm == "Placebo")
  
  neg_surv <- neg_total - sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  pos_surv <- pos_total - sum(circ_data$altair.Arm == "Placebo" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  
  surv_matrix <- matrix(c(neg_surv, pos_surv, neg_total - neg_surv, pos_total - pos_surv), nrow = 2)
  test_result <- fisher.test(surv_matrix)
  return(test_result$p.value)
})
names(p_values) <- paste0("p-value at ", dfs_times, " months")
print(p_values)
```


#DFS1 by ctDNA Surveillance timepoint TAS vs Placebo
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$p_AltBaselineWin=="Surveillance",]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - ctDNA Surveillance Enrollment", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Fisher test for DFS percentages at 6, 12, 18 and 24 months
dfs_times <- c(6, 12, 18, 24)
p_values <- sapply(dfs_times, function(time) {
  neg_count <- sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  pos_count <- sum(circ_data$altair.Arm == "Placebo" & circ_data$DFS.months >= time & circ_data$p_evtDFS1b == 0)
  neg_total <- sum(circ_data$altair.Arm == "FTD/TPI")
  pos_total <- sum(circ_data$altair.Arm == "Placebo")
  
  neg_surv <- neg_total - sum(circ_data$altair.Arm == "FTD/TPI" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  pos_surv <- pos_total - sum(circ_data$altair.Arm == "Placebo" & circ_data$p_evtDFS1b == 1 & circ_data$DFS.months < time)
  
  surv_matrix <- matrix(c(neg_surv, pos_surv, neg_total - neg_surv, pos_total - pos_surv), nrow = 2)
  test_result <- fisher.test(surv_matrix)
  return(test_result$p.value)
})
names(p_values) <- paste0("p-value at ", dfs_times, " months")
print(p_values)
```


#Barplot with enrollment timepoint at any time by Arm
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")

circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
circ_data$p_AltBaselineWin <- factor(circ_data$p_AltBaselineWin, levels = c("MRD", "OnTreatment", "Surveillance"), labels = c("MRD", "On Treatment", "Surveillance"))
contingency_table <- table(circ_data$altair.Arm, circ_data$p_AltBaselineWin)
chi_square_test <- chisq.test(contingency_table)
print(chi_square_test)
fisher_exact_test <- fisher.test(contingency_table)
print(fisher_exact_test)
print(contingency_table)
p_values <- c(chi_square_test$p.value, fisher_exact_test$p.value)
p_adjusted <- p.adjust(p_values, method = "bonferroni")
names(p_adjusted) <- c("Chi-Square Test", "Fisher's Exact Test")
print(p_adjusted)
table_df <- as.data.frame(contingency_table)
table_df$Total <- ave(table_df$Freq, table_df$Var1, FUN = sum)
table_df$Percentage <- table_df$Freq / table_df$Total
table_df$MiddlePercentage <- table_df$Percentage / 2
ggplot(table_df, aes(x = Var1, y = Percentage, fill = Var2)) +
  geom_bar(stat = "identity") +
  geom_text(aes(y = MiddlePercentage, label = Freq), position = "stack", color = "black", vjust = 1.5, size = 7) +
  theme_minimal() +
  labs(title = "Enrollment timepoint", 
       x = "Arm", 
       y = "Patients (%)", 
       fill = "Enrollment timepoint",
       caption = paste("Chi-squared test p-value: ", format.pval(chi_square_test$p.value))) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c("Surveillance" = "lightblue", "On Treatment" = "lightgreen", "MRD" = "salmon")) + # define custom colors
  theme(axis.text.x = element_text(angle = 0, hjust = 1.5, size = 14), # increase x-axis text size
        axis.text.y = element_text(size = 14, color = "black"), # increase y-axis text size
        axis.title.x = element_text(size = 14, color = "black"), # increase x-axis label size
        axis.title.y = element_text(size = 14, color = "black"), # increase y-axis label size
        legend.text = element_text(size = 12, color = "black"))  # increase Recurrence label size

#Calculate median MTM/mL for enrollment timepoint
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
result <- circ_data %>%
  group_by(p_AltBaselineWin) %>%
  summarise(
    Median = median(p_AltBaselineMTM, na.rm = TRUE),
    Range = paste(min(p_AltBaselineMTM, na.rm = TRUE), max(p_AltBaselineMTM, na.rm = TRUE), sep = " - ")
  )
print(result)
```

#DFS1 by TAS vs Placebo - All stages MTM/mL based on the lowest MTM/mL upon which the trial is positive
```{r}
#Pts with MTM/mL≥0.047
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")

total_pts <- nrow(circ_data)
pts_MTM <- nrow(circ_data[circ_data$p_AltBaselineMTM >= 0.047,])
percentage_pts_MTM <- (pts_MTM / total_pts) * 100
print(paste0("Percentage of patients with MTM ≥ 0.047: ", round(percentage_pts_MTM, 2), "%"))

circ_data <- circ_data[circ_data$p_AltBaselineMTM>=0.047,]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - MTM/mL ≥0.047", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Pts with MTM/mL<0.047
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")

total_pts <- nrow(circ_data)
pts_MTM <- nrow(circ_data[circ_data$p_AltBaselineMTM < 0.047,])
percentage_pts_MTM <- (pts_MTM / total_pts) * 100
print(paste0("Percentage of patients with MTM < 0.047: ", round(percentage_pts_MTM, 2), "%"))

circ_data <- circ_data[circ_data$p_AltBaselineMTM<0.047,]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.Arm, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.Arm) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","blue"), title="DFS1 by Arm - MTM/mL <0.047", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("Placebo", "FTD/TPI"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
cox_fit <- coxph(surv_object ~ altair.Arm, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Analysis for Likelihood-Ratio Interaction P value
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data$p_evtDFS1b  <- as.logical(circ_data$p_evtDFS1b)
circ_data$DFS.months <- as.numeric(circ_data$DFS.months)

circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))
circ_data$ctDNA.MTM <- NA
circ_data <- circ_data %>%
  mutate(ctDNA.MTM = case_when(
    p_AltBaselineMTM<0.047 ~ 1,
    p_AltBaselineMTM>=0.047 ~ 2
  ))
circ_data$ctDNA.MTM <- factor(circ_data$ctDNA.MTM, levels=c("1","2"), labels = c("<0.047", "≥0.047"))
surv_object <- Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
cox_model_main <- coxph(surv_object ~ ctDNA.MTM + altair.Arm, data = circ_data)
cox_model_interaction <- coxph(surv_object ~ ctDNA.MTM * altair.Arm, data = circ_data)
lrt_result <- anova(cox_model_main, cox_model_interaction, test = "LRT")
print(lrt_result)
```




#DFS1 by TAS vs Placebo - MTM/mL as continuous variable
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data$p_evtDFS1b  <- as.logical(circ_data$p_evtDFS1b)
circ_data$DFS.months <- as.numeric(circ_data$DFS.months)
circ_data$p_AltBaselineMTM <- as.numeric(circ_data$p_AltBaselineMTM)
circ_data$altair.Arm <- factor(circ_data$altair.Arm, levels=c("Control","Experimental"), labels = c("Placebo", "FTD/TPI"))

#############################################################################
# 3. Define cutoffs (0.01 to 100 on a normal numeric scale)
#############################################################################
cutoffs <- seq(0.01, 100, length.out = 50)

# Prepare a data frame to store results
results_df <- data.frame(
  cutoff = cutoffs,
  HR     = NA_real_,
  HR_low = NA_real_,
  HR_hi  = NA_real_,
  pval   = NA_real_,
  n_included = NA_integer_
)

#############################################################################
# 4. Loop over each cutoff: subselect data and fit Cox model (Placebo vs. TAS-102)
#############################################################################
for (i in seq_along(cutoffs)) {
  
  current_cutoff <- cutoffs[i]
  
  # Subset: patients with p_AltBaselineMTM >= current_cutoff
  sub_data <- circ_data %>%
    filter(p_AltBaselineMTM >= current_cutoff)
  
  # Re-factor in case any level is dropped
  sub_data$altair.Arm <- factor(sub_data$altair.Arm, levels = c("Placebo", "FTD/TPI"))
  
  # Only run the Cox model if both arms have at least some minimal data
  arm_counts <- table(sub_data$altair.Arm)
  if (length(arm_counts) == 2 && all(arm_counts >= 2)) {
    
    fit <- coxph(Surv(DFS.months, p_evtDFS1b) ~ altair.Arm, data = sub_data)
    fit_sum <- summary(fit)
    
    # Extract HR, 95% CI, and p-value
    hr          <- fit_sum$conf.int[,"exp(coef)"][1]
    hr_conf_low <- fit_sum$conf.int[,"lower .95"][1]
    hr_conf_hi  <- fit_sum$conf.int[,"upper .95"][1]
    pval        <- fit_sum$coefficients[,"Pr(>|z|)"][1]
    
    # Store in results_df
    results_df$HR[i]     <- hr
    results_df$HR_low[i] <- hr_conf_low
    results_df$HR_hi[i]  <- hr_conf_hi
    results_df$pval[i]   <- pval
    results_df$n_included[i] <- nrow(sub_data)
    
  } else {
    results_df$n_included[i] <- nrow(sub_data)
  }
}

#############################################################################
# 5. Plot: x-axis on log scale, y-axis with breaks at 0.05, 0.1, 0.25, 0.5, 1, 2
#############################################################################
plot_df <- results_df %>%
  filter(!is.na(HR))

# Plot
p <- ggplot(plot_df, aes(x = cutoff, y = HR)) +
  # Ribbon for confidence intervals
  geom_ribbon(aes(ymin = HR_low, ymax = HR_hi), alpha = 0.2) +
  # Line for the HR
  geom_line(size = 1) +
  # Reference line at HR=1
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  
  # X-axis on log scale
  scale_x_log10(
    breaks = c(0.01, 0.1, 1, 10, 100), 
    labels = c("0.01", "0.1", "1", "10", "100")
  ) +
  
  # Y-axis on normal (linear) scale with specific breaks
  scale_y_log10(
    breaks = c(0.1, 0.3, 1, 3),
    labels = c("0.1", "0.3", "1", "3"),
    limits = c(0.1, 3)   # Adjust or remove if needed
  ) +
  
  theme_bw(base_size = 14) +
  labs(
    title = "Hazard Ratio (Placebo vs. TAS-102) by MTM/mL",
    x     = "MTM/mL (log scale)",
    y     = "Hazard Ratio (log scale)"
  )

print(p)

# Find the 2nd MTM cutoff where the upper bound of the confidence interval (HR_hi) crosses HR = 1
crossing_point <- results_df %>% 
  filter(HR_hi >= 1) %>% 
  slice(2)  # Select the 2nd occurrence

# Print the cutoff value where HR_hi crosses 1
print(crossing_point$cutoff)

#############################################################################
# 6. (Optional) Add vertical lines for specific cutoffs
#############################################################################
p + 
  geom_vline(
    xintercept = c(0.047, 0.179, 8.172),
    linetype   = "dashed",
    color      = "blue"
  ) +
  annotate(
    "text", 
    x     = c(0.179, 8.172), 
    y     = max(plot_df$HR_hi, na.rm = TRUE),
    label = c("0.179", "8.172"), 
    vjust = -0.5, 
    color = "blue"
  )
```


#Histogram for number of patients per enrolment MTM/mL
```{r}
rm(list = ls())
setwd("~/Downloads")

df <- read.csv("Altair 20240729 Dataset.csv")
df$p_evtDFS1b      <- as.logical(df$p_evtDFS1b)
df$DFS.months      <- as.numeric(df$DFS.months)
df$p_AltBaselineMTM <- as.numeric(df$p_AltBaselineMTM)

# Clean the data
df <- df %>% filter(!is.na(p_AltBaselineMTM), p_AltBaselineMTM > 0)

# Descriptive stats (note: use the correct column name)
ppm_range  <- range(df$p_AltBaselineMTM)
lowest_ppm <- ppm_range[1]
highest_ppm <- ppm_range[2]
median_ppm <- median(df$p_AltBaselineMTM)

cat("Lowest PPM value :", lowest_ppm, "\n")
cat("Highest PPM value:", highest_ppm, "\n")
cat("Median PPM value :", median_ppm, "\n")
cat("Full range       :", lowest_ppm, "to", highest_ppm, "\n\n")

# Histogram with custom log‑scale breaks
ggplot(df, aes(x = p_AltBaselineMTM)) +
  geom_histogram(bins = 100, fill = "gray80", color = "black") +
  scale_x_log10(
    breaks  = c(0.01, 0.1, 1, 10, 100),
    labels  = c("0.01", "0.1", "1", "10", "100")
  ) +
  labs(x = "p_AltBaselineMTM", y = "Number of samples") +
  ylim(0, 10) +
  theme_minimal()
```

#Enrollment MTM/mL by ctDNA clearance in TAS-102 vs Placebo Arms
```{r}
#Placebo
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$altair.group.SAP_MSv2!="1b = Exclude: No on-Tx TPs",]
circ_data <- circ_data[circ_data$altair.Arm=="Control",]

# Transform p_MRD_MTM with log10
circ_data$p_AltBaselineMTM <- as.numeric(as.character(circ_data$p_AltBaselineMTM))
circ_data$p_evtDFS1b <- factor(circ_data$p_evtDFS1b, levels=c("TRUE","FALSE"), labels = c("Recurrence", "No Recurrence"))
circ_data$altair.resultPatW <- factor(circ_data$altair.resultPatW, levels=c("No clearance", "Transient clearance", "Sustained clearance"))
median_p_MRD_MTM <- aggregate(p_AltBaselineMTM ~ altair.resultPatW, data = circ_data, FUN = median)
print(median_p_MRD_MTM)

# Create violin plot with log10 scale on y-axis
ggplot(circ_data, aes(x=altair.resultPatW, y=p_AltBaselineMTM, fill=altair.resultPatW)) +
  geom_violin(trim=FALSE) +
  scale_fill_manual(values=c("Sustained clearance"="lightblue", "Transient clearance"="lightgreen", "No clearance"="salmon")) +
  geom_boxplot(width=0.1, fill="white", colour="black", alpha=0.5) +
  scale_y_log10(breaks=c(0.001, 0.01, 0.1, 1, 10, 100, 1000, 10000)) +
  labs(title="Enrollment MTM/mL | Clearance - Placebo Arm", x="Clearance", y="Enrollment MTM/mL") +
  theme_minimal() +
  theme(legend.position="none")
m3_1v2 <- wilcox.test(p_AltBaselineMTM ~ altair.resultPatW,
                      data = circ_data[circ_data$altair.resultPatW %in% c("Sustained clearance", "Transient clearance"), ],
                      na.rm = TRUE)
print(m3_1v2)
m3_1v3 <- wilcox.test(p_AltBaselineMTM ~ altair.resultPatW,
                      data = circ_data[circ_data$altair.resultPatW %in% c("Sustained clearance", "No clearance"), ],
                      na.rm = TRUE)
print(m3_1v3)
m3_2v3 <- wilcox.test(p_AltBaselineMTM ~ altair.resultPatW,
                      data = circ_data[circ_data$altair.resultPatW %in% c("Transient clearance", "No clearance"), ],
                      na.rm = TRUE)
print(m3_2v3)

# Create a table with p-values
p_value_table <- data.frame(
  Comparison = c("Sustained vs Transient", "Sustained vs No Clearance", "Transient vs No Clearance"),
  P_Value = c(m3_1v2$p.value, m3_1v3$p.value, m3_2v3$p.value)
)
print(p_value_table)

#TAS-102
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$altair.group.SAP_MSv2!="1b = Exclude: No on-Tx TPs",]
circ_data <- circ_data[circ_data$altair.Arm=="Experimental",]

# Transform p_MRD_MTM with log10
circ_data$p_AltBaselineMTM <- as.numeric(as.character(circ_data$p_AltBaselineMTM))
circ_data$p_evtDFS1b <- factor(circ_data$p_evtDFS1b, levels=c("TRUE","FALSE"), labels = c("Recurrence", "No Recurrence"))
circ_data$altair.resultPatW <- factor(circ_data$altair.resultPatW, levels=c("No clearance", "Transient clearance", "Sustained clearance"))
median_p_MRD_MTM <- aggregate(p_AltBaselineMTM ~ altair.resultPatW, data = circ_data, FUN = median)
print(median_p_MRD_MTM)

# Create violin plot with log10 scale on y-axis
ggplot(circ_data, aes(x=altair.resultPatW, y=p_AltBaselineMTM, fill=altair.resultPatW)) +
  geom_violin(trim=FALSE) +
  scale_fill_manual(values=c("Sustained clearance"="lightblue", "Transient clearance"="lightgreen", "No clearance"="salmon")) +
  geom_boxplot(width=0.1, fill="white", colour="black", alpha=0.5) +
  scale_y_log10(breaks=c(0.001, 0.01, 0.1, 1, 10, 100, 1000, 10000)) +
  labs(title="Enrollment MTM/mL | Clearance - TAS-102 Arm", x="Clearance", y="Enrollment MTM/mL") +
  theme_minimal() +
  theme(legend.position="none")
m3_1v2 <- wilcox.test(p_AltBaselineMTM ~ altair.resultPatW,
                      data = circ_data[circ_data$altair.resultPatW %in% c("Sustained clearance", "Transient clearance"), ],
                      na.rm = TRUE)
print(m3_1v2)
m3_1v3 <- wilcox.test(p_AltBaselineMTM ~ altair.resultPatW,
                      data = circ_data[circ_data$altair.resultPatW %in% c("Sustained clearance", "No clearance"), ],
                      na.rm = TRUE)
print(m3_1v3)
m3_2v3 <- wilcox.test(p_AltBaselineMTM ~ altair.resultPatW,
                      data = circ_data[circ_data$altair.resultPatW %in% c("Transient clearance", "No clearance"), ],
                      na.rm = TRUE)
print(m3_2v3)

# Create a table with p-values
p_value_table <- data.frame(
  Comparison = c("Sustained vs Transient", "Sustained vs No Clearance", "Transient vs No Clearance"),
  P_Value = c(m3_1v2$p.value, m3_1v3$p.value, m3_2v3$p.value)
)
print(p_value_table)
```

#DFS1 by ctDNA Clearance with 3 groups - All stages
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$altair.group.SAP_MSv2!="1b = Exclude: No on-Tx TPs",]

circ_data$altair.resultPatW <- factor(circ_data$altair.resultPatW, levels=c("No clearance", "Transient clearance", "Sustained clearance"))
survfit(Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)~altair.resultPatW, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.resultPatW) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtDFS1b),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.resultPatW, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","green","blue"), title="DFS1 by Arm - ctDNA Clearance", ylab= "Disease-Free Survival", xlab="Time from Enrollment (Months)", legend.labs=c("No clearance", "Transient clearance",  "Sustained clearance"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.resultPatW <- factor(circ_data$altair.resultPatW, levels=c("Sustained clearance", "Transient clearance", "No clearance"))
cox_fit <- coxph(surv_object ~ altair.resultPatW, data=circ_data) 
ggforest(cox_fit,data = circ_data)
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)
```




#OS by ctDNA Clearance with 3 groups - All stages
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20240729 Dataset.csv")
circ_data <- circ_data[circ_data$altair.group.SAP_MSv2!="1b = Exclude: No on-Tx TPs",]

circ_data$altair.resultPatW <- factor(circ_data$altair.resultPatW, levels=c("No clearance", "Transient clearance", "Sustained clearance"))
survfit(Surv(time = circ_data$OS.months, event = circ_data$p_evtOS)~altair.resultPatW, data = circ_data)
event_summary <- circ_data %>%
  group_by(altair.resultPatW) %>%
  summarise(
    Total = n(),
    Events = sum(p_evtOS),
    Fraction = Events / n(),
    Percentage = (Events / n()) * 100
  )
print(event_summary)
surv_object <-Surv(time = circ_data$OS.months, event = circ_data$p_evtOS)
KM_curve <- survfit(surv_object ~ altair.resultPatW, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("red","green","blue"), title="OS by Arm - ctDNA Clearance", ylab= "Overall Survival", xlab="Time from Enrollment (Months)", legend.labs=c("No clearance", "Transient clearance",  "Sustained clearance"), legend.title="")
summary(KM_curve, times= c(6, 12, 18, 24))
circ_data$altair.resultPatW <- factor(circ_data$altair.resultPatW, levels=c("Sustained clearance", "Transient clearance", "No clearance"))
cox_fit <- coxphf(surv_object ~ altair.resultPatW, data=circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)
```


#DFS1 by TAS vs Placebo - Central review data - All stages & stratified for Stage & ctDNA 1mo post-surgery
```{r}
rm(list = ls())
setwd("~/Downloads")
circ_data <- read.csv("Altair 20250903 Central Imaging Dataset.csv")
circ_data <- as.data.frame(circ_data)

circ_data$altair.Arm    <- factor(circ_data$altair.Arm, levels = c("Control","Experimental"), labels = c("Placebo","FTD/TPI"))
circ_data$Disease.Stage <- factor(circ_data$Disease.Stage, levels = c("Stage II or lower","StageIII","M1"))
circ_data$ctDNA1mo      <- factor(circ_data$ctDNA1mo, levels = c("NEGATIVE","POSITIVE"), labels = c("Negative","Positive"))

event_summary <- circ_data %>% group_by(altair.Arm) %>% summarise(Total = n(), Events = sum(p_evtDFS1b), Fraction = Events / n(), Percentage = (Events / n()) * 100)
print(event_summary)
surv_object <- Surv(time = circ_data$DFS.months, event = circ_data$p_evtDFS1b)
KM_curve <- survfit(surv_object ~ altair.Arm, data = circ_data, conf.int = 0.95, conf.type = "log-log")

# --- Stratified log-rank test (exactly as in primary analysis) ---
# Use survdiff with the same stratification factors
sd_strat <- survdiff(surv_object ~ altair.Arm + strata(Disease.Stage, ctDNA1mo), data = circ_data)
# For two groups, df = 1
p_strat_logrank <- 1 - pchisq(sd_strat$chisq, df = 1)

# KM plot with the stratified p-value displayed
ggsurvplot(KM_curve, data = circ_data, pval = sprintf("Stratified log-rank p = %.4f", p_strat_logrank), conf.int = FALSE, risk.table = TRUE, break.time.by = 6, palette = c("red","blue"), title = "DFS1 by Arm - All Patients", ylab = "Disease-Free Survival", xlab = "Time from Enrollment (Months)", legend.labs = c("Placebo", "FTD/TPI"), legend.title = "")
print(summary(KM_curve, times = c(6, 12, 18, 24)))
cox_fit_stratified <- coxph(surv_object ~ altair.Arm + strata(Disease.Stage) + strata(ctDNA1mo), data = circ_data)
cox_fit_summary_stratified <- summary(cox_fit_stratified)
print(cox_fit_summary_stratified)
HR_stratified       <- cox_fit_summary_stratified$conf.int["altair.ArmFTD/TPI","exp(coef)"]
lower_CI_stratified <- cox_fit_summary_stratified$conf.int["altair.ArmFTD/TPI","lower .95"]
upper_CI_stratified <- cox_fit_summary_stratified$conf.int["altair.ArmFTD/TPI","upper .95"]

# --- Use SCORE (log-rank) p-value from the Cox fit ---
if (!is.null(cox_fit_summary_stratified$score)) {
  score_stat <- cox_fit_summary_stratified$score
} else {
  score_stat <- as.numeric(cox_fit_summary_stratified$sctest["test"])
}
p_value_score <- 1 - pchisq(score_stat, df = 1)

# (Optional) Wald p-value for reference
p_value_wald <- as.numeric(cox_fit_summary_stratified$wald["pvalue"])

# Label using SCORE p-value
label_text_stratified <- paste0(
  "HR = ", round(HR_stratified, 2),
  " (", round(lower_CI_stratified, 2), "-",
  round(upper_CI_stratified, 2), "); p (score) = ",
  format.pval(p_value_score, digits = 3)
)
print(label_text_stratified)

#print both p-values side-by-side:
cat(sprintf("Stratified log-rank (survdiff) p = %.4f\n", p_strat_logrank))
cat(sprintf("Cox score-test p = %.4f (Wald p = %.4f)\n", p_value_score, p_value_wald))
```



